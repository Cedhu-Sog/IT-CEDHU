{# usuarios/templates/usuarios/gestionar_accesos.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Gestionar Accesos: {{ target_user.email }}{% endblock %}

{% block header_title %}Gestionar Accesos y Permisos{% endblock %}

{% block breadcrumbs %}
    {% include 'components/breadcrumbs.html' %}
    <li class="breadcrumb-item"><a href="{% url 'usuarios:perfil' pk=user.pk %}">Mi Perfil</a></li>
    <li class="breadcrumb-item active" aria-current="page">Gestionar: {{ target_user.email }}</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow-lg border-0 rounded-lg">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i> Editando Accesos de: **{{ target_user.get_full_name|default:target_user.email }}**</h5>
            </div>
            <div class="card-body">
                
                <p class="text-danger small">
                    **¡ADVERTENCIA!** Estás modificando los privilegios de otro usuario. Procede con precaución.
                </p>

                <form method="post">
                    {% csrf_token %}
                    
                    {# ---------------------------------------------------- #}
                    {# Mensajes de Error Global #}
                    {# ---------------------------------------------------- #}
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            {% for error in form.non_field_errors %}
                                <p class="mb-0">{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    {# ---------------------------------------------------- #}
                    {# Campos de Estado y Staff (Staff status y Active) #}
                    {# ---------------------------------------------------- #}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check form-switch p-4 border rounded">
                                {{ form.is_active }}
                                <label class="form-check-label fw-bold" for="{{ form.is_active.id_for_label }}">
                                    Usuario Activo (is_active)
                                </label>
                                <p class="small text-muted mb-0">Si está desmarcado, el usuario no podrá iniciar sesión.</p>
                            </div>
                            {% if form.is_active.errors %}
                                <small class="text-danger d-block">{{ form.is_active.errors.as_text }}</small>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check form-switch p-4 border rounded">
                                {{ form.is_staff }}
                                <label class="form-check-label fw-bold" for="{{ form.is_staff.id_for_label }}">
                                    Acceso a Staff (is_staff)
                                </label>
                                <p class="small text-muted mb-0">Permite el acceso al Panel de Administración de Django.</p>
                            </div>
                            {% if form.is_staff.errors %}
                                <small class="text-danger d-block">{{ form.is_staff.errors.as_text }}</small>
                            {% endif %}
                        </div>
                    </div>
                    
                    {# ---------------------------------------------------- #}
                    {# Grupos y Permisos #}
                    {# ---------------------------------------------------- #}
                    <hr>
                    <h6 class="mb-3 fw-bold">Gestión de Grupos y Permisos (Avanzado)</h6>
                    
                    {# Grupos #}
                    <div class="mb-4">
                        <label for="{{ form.groups.id_for_label }}" class="form-label fw-bold">Grupos Asignados</label>
                        {{ form.groups }}
                        <p class="form-text text-muted">Mantén Ctrl/Cmd para seleccionar múltiples grupos.</p>
                        {% if form.groups.errors %}
                            <small class="text-danger d-block">{{ form.groups.errors.as_text }}</small>
                        {% endif %}
                    </div>
                    
                    {# Permisos de Usuario (Individuales) #}
                    <div class="mb-4">
                        <label for="{{ form.user_permissions.id_for_label }}" class="form-label fw-bold">Permisos Específicos</label>
                        {{ form.user_permissions }}
                        <p class="form-text text-muted">Estos son permisos individuales que anulan la configuración de grupos.</p>
                        {% if form.user_permissions.errors %}
                            <small class="text-danger d-block">{{ form.user_permissions.errors.as_text }}</small>
                        {% endif %}
                    </div>
                    
                    {# ---------------------------------------------------- #}
                    {# Botón de Guardar #}
                    {# ---------------------------------------------------- #}
                    <div class="mt-4 pt-2 border-top">
                        <button type="submit" class="btn btn-danger btn-lg">
                            <i class="fas fa-lock me-2"></i> Aplicar Cambios de Acceso
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="card-footer py-3">
                <p class="mb-0">
                    <a href="{% url 'inventario:dashboard' %}" class="text-decoration-none">
                        <i class="fas fa-arrow-left me-1"></i> Volver al Dashboard
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}